<html>
<head><title> Collaborative Document Editing</title> </head>
<body>
	<h1 style="text-align:center;"> Shared Document 1</h1>
	<div style="margin-left:200px;">
		<textarea id="mainDoc" style="width:900px;height:400px;"></textarea>
		<div style="margin-top:20px;">
			<button id="connectToServer"  style="display:block;" value="connect" >Connect</button>
			<span>
				Key pressed : <span id="textReplace"> </span>  ... &nbsp; &nbsp;Location :
			</span>
			<span id="location"></span>
		<div>
		<div id="demoText"> AAA </div>
		<div id="clientId" style="display:none;"></div>
	<script type="text/javascript">

var mainDoc = document.getElementById("mainDoc");
var header_sent=0;

function setUpPersistantConnection(e){
	xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function(){
		try{
			if( xmlhttp.status==200){
				//alert("ready state : " + xmlhttp.readyState );
				if(header_sent!=0){
				var textSent = new String(xmlhttp.responseText);
				//alert("response text : " + xmlhttp.responseText );
				//document.getElementById("mainDoc").value = textSent;
				//document.getElementById("mainDoc").innerHTML= textSent;
				document.getElementById("mainDoc").value+= textSent.charAt(textSent.length-2);
				
				//console.log("SET CHAR IN BOX : " + textSent.charAt(textSent.length-2) );
				}else{
					//alert("Header sent : " + xmlhttp.responseText );
					console.log("CHAR got : "+xmlhttp.responseText + " , response len ; " + xmlhttp.responseText.length );
					if(xmlhttp.responseText.length!=0){
						header_sent =1; 
						var initialText = xmlhttp.responseText;
						document.getElementById("clientId").innerHTML = initialText.charAt( initialText.length - 2) ;
					}
				}
			}
		}catch(e){
			console.log(e.message + " Xml status : ");
		}
		//xmlhttp.responseText = "";
	};
	xmlhttp.open("POST","http://192.168.0.9:5000",true);
	xmlhttp.send("STUFF POSTED");
};

function returnKeyFromCode(code){
 	if(code == 8)
	 	var charPressed = "Backspace";
	 else if(code == 32)
	 	var charPressed = " "; //Spacebar
	 else if(code == 0)
	 	var charPressed = "delete";
	 else 
	 	var charPressed = String.fromCharCode(code);
	return charPressed;
};

function keyPress(e){
	var textReplace = document.getElementById("textReplace");
	var keyPressed = returnKeyFromCode(e.which)  ;
	textReplace.innerHTML = keyPressed;
	var locationReplace = document.getElementById("location");
	locationReplace.innerHTML = mainDoc.selectionStart;
	var clientId = document.getElementById("clientId").innerHTML;

	xmlhttp1=new XMLHttpRequest();
	xmlhttp1.onreadystatechange=function(){
	};
	xmlhttp1.open("POST","http://192.168.0.9:5000?key=" + keyPressed + "&pos=" +mainDoc.selectionStart +"&revno=1&cid="+clientId +"&param=EOS",true);
	xmlhttp1.send("Stuff");
};

function setEventHandlers(){
	mainDoc.onkeypress = function(e){keyPress(e);}
	var connectButton=document.getElementById("connectToServer");
	connectButton.onclick=function(e){setUpPersistantConnection(e);}
};

function main(){
	setEventHandlers();	
}
main();
</script>
	</div>

</body>
</html>
