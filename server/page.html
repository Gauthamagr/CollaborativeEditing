<html>
<head><title> Collaborative Document Editing</title> </head>
<body>
	<h1 style="text-align:center;"> Shared Document 1</h1>
	<div style="margin-left:200px;">
		<textarea id="mainDoc" style="width:900px;height:400px;"></textarea>
		<div style="margin-top:20px;">
			<button id="connectToServer"  style="display:block;" value="connect" >Connect</button>
			<span>
				Key pressed : <span id="textReplace"> </span>  ... &nbsp; &nbsp;Location :
			</span>
			<span id="location"></span>
		<div>
		<div id="demoText"> AAA </div>
	<script type="text/javascript">

var mainDoc = document.getElementById("mainDoc");
var header_sent=0;

function setUpPersistantConnection(e){
	xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function(){
		try{
			if( xmlhttp.status==200){
				//alert("ready state : " + xmlhttp.readyState );
				if(header_sent!=0){
				var textSent = new String(xmlhttp.responseText);
					//alert("str "+textSent+" len : "+textSent.length+" last char : "+textSent.charAt(textSent.length-2));
				//document.getElementById("mainDoc").innerHTML= textSent;
				document.getElementById("mainDoc").innerHTML+= textSent.charAt(textSent.length-2);
				}else{
					header_sent=1;
				}
			}
		}catch(e){
			//alert(e.message);
			console.log(e.message + " Xml status : ");
		}
		//alert("Inner html : " + xmlhttp.responseText );
		//xmlhttp.responseText = "";
	};
	xmlhttp.open("POST","http://192.168.0.9:5000",true);
	xmlhttp.send("STUFF POSTED");
};

function returnKeyFromCode(code){
 	if(code == 8)
	 	var charPressed = "Backspace";
	 else if(code == 32)
	 	var charPressed = " "; //Spacebar
	 else if(code == 0)
	 	var charPressed = "delete";
	 else 
	 	var charPressed = String.fromCharCode(code);
	return charPressed;
};

function keyPress(e){
	var textReplace = document.getElementById("textReplace");
	var keyPressed = returnKeyFromCode(e.which)  ;
	textReplace.innerHTML = keyPressed;
	var locationReplace = document.getElementById("location");
	locationReplace.innerHTML = mainDoc.selectionStart;

	xmlhttp=new XMLHttpRequest();
	xmlhttp.onreadystatechange=function(){
	};
	//xmlhttp.open("POST","http://localhost:5000",true);
	xmlhttp.open("POST","http://192.168.0.9:5000?key=" + keyPressed + "&pos=" +mainDoc.selectionStart +"&revno=1&param=EOS",true);
	xmlhttp.send("Stuff");
};

function setEventHandlers(){
	mainDoc.onkeypress = function(e){keyPress(e);}
	var connectButton=document.getElementById("connectToServer");
	connectButton.onclick=function(e){setUpPersistantConnection(e);}
};

function main(){
	setEventHandlers();	
}
main();
</script>
	</div>

</body>
</html>
