<html>
<head><title> Collaborative Document Editing</title> </head>
<body>
	<h1 style="text-align:center;"> Shared Document 1</h1>
	<div style="margin-left:200px;">
		<textarea id="mainDoc" style="width:900px;height:100px;"></textarea>
		<div style="margin-top:20px;">
			<button id="connectToServer"  style="display:block;" value="connect" >Connect</button>
			<span>
				Key pressed : <span id="textReplace"> </span>  ... &nbsp; &nbsp;Location :
			</span>
			<span id="location"></span>
		<div>
		<div id ="clientId"></div>
		<div id ="Q"></div>
		<div id = "Buf"></div> 
		<div id = "Q_version_number" >0</div> 
		<div id = "buffer_version_number">0</div> 
		<div id = "add_QtoBuffer"></div>
	<script type="text/javascript">

var mainDoc = document.getElementById("mainDoc");
var version1 = 0;
var header_sent=0;
var tmp = "Hello";
var ommit_char = "arrow";
var DELETE = "Y";
var BACKSPACE = "X";

function getBufferContent(){
	return document.getElementById("Buf").innerHTML;
}

function getClientId(){
	return document.getElementById("clientId").innerHTML;
}

function setClientId(clientId){
	document.getElementById("clientId").innerHTML = clientId;
}

function getQueueContent(){
	return document.getElementById("Q").innerHTML;
}

function setQueueContent(queueContent){
	document.getElementById("Q").innerHTML = queueContent;
}

function getQueueVersionNumber(){
	return document.getElementById("Q_version_number").innerHTML;
}

function getBufferVersionNumber(){
	return document.getElementById("buffer_version_number").innerHTML;
}

function setBufferVersionNumber(buffer_version_number){
	document.getElementById("buffer_version_number").innerHTML = buffer_version_number;
}

function setUIContent(UIContent){
	document.getElementById("mainDoc").value = UIContent;	
}

function updateBuffer(key,pos,serverBufferNumber){
	var oldBuffer = getBufferContent();
	console.log("Inside update buffer : key :" + key + ". Pos : " + pos + "Server Version : " + serverBufferNumber);
	if(key != BACKSPACE && key != DELETE) {
		if(pos < oldBuffer.length)	 {
			console.log("BUF updated !!!!!!!!!!!!!!! oldBuffer : " + oldBuffer + " ,,,, its len : " + oldBuffer.length);
			document.getElementById("Buf").innerHTML = oldBuffer.substring(0,pos) + key +oldBuffer.substring(pos);
		} else
			document.getElementById("Buf").innerHTML += key;  

	 } else if (key == BACKSPACE) { 

		//console.log("Inside Backspace");
		if (pos == 1)
	    	document.getElementById("Buf").innerHTML = oldBuffer.substring(1);
	   	else
	   		document.getElementById("Buf").innerHTML = oldBuffer.substring(0,pos-1) + oldBuffer.substring(pos);
	 } else {
		//console.log("Inside Delete");	 
	   	if (pos == 0)
	   		document.getElementById("Buf").innerHTML = oldBuffer.substring(1);
	   	else
	   		document.getElementById("Buf").innerHTML = oldBuffer.substring(0,pos) + oldBuffer.substring(pos+1);
	 }

	setBufferVersionNumber( serverBufferNumber );
}

function insertQ(key,pos,clientId) {

	var q_version_num = getQueueVersionNumber();
	var buffer_version_number = getBufferVersionNumber();
	var Q = getQueueContent();
	//console.log("Q Version Number : " + parseInt(q_version_num));
	q_version_num  = parseInt(q_version_num) + 1;

	if (key != ommit_char) {
		tmp = key +  "," + pos + "," + clientId + "," + q_version_num + "," + buffer_version_number + "|";
		Q = Q + tmp;
		setQueueContent(Q);
		//console.log(tmp);
		document.getElementById("Q_version_number").innerHTML = q_version_num;
	}   
	return q_version_num;
}

function updateClientBuf(textSent)
{
	var Q1    = getQueueContent();
	var buff  = getBufferContent();
	var clientID = getClientId();
	var flag  =  0;    
	var queue =  Q1.split("|"); 
	var qtuple = queue[0].split(",");
	//console.log("Split of queue : " + queue[0] + queue[1] + queue[2] );
	//console.log("Client Queue length : " + queue.length + ", " + Q1.length);
	//Section to handle 'ACK'
	var lastTuple    = textSent.substring((textSent.lastIndexOf("|",textSent.length-5) + 1), textSent.lastIndexOf("|"));
	var serverTuple   = lastTuple.split(",");

	if(serverTuple[0] == '%' )
		serverTuple[0]=" ";

	var charInMessage = serverTuple[0] ;
	var positionInMessage = parseInt(serverTuple[1]);
	var clientIdInMessage = serverTuple[2];
	var serverBufferNumberInMessage = serverTuple[3];
		
	if(clientIdInMessage == clientID) {
		//Code to handle Acknowledgement message

	   	for(i=0;i<4;i++) {
	   	    //console.log("Comparing "+ i + ". ServerTuple : " + serverTuple[i] + ". Queue : " +  qtuple[i]);
		 	if(serverTuple[i] == qtuple[i])
		  	   flag = 1;
		 	else 
		  	   break;  
	   	} 
	   	if(flag){
			//Remove element from Queue
			console.log("Buffer B4 ACK MSG =  " + getBufferContent());
			setQueueContent( Q1.substring(Q1.indexOf("|") + 1,Q1.length) );
		  	updateBuffer( charInMessage , positionInMessage , serverBufferNumberInMessage);
			console.log("Buffer after ACK MSG =  " + getBufferContent());
	   	}
	} else { 
		//Code to handle Broadcast message

		var client_q = getQueueContent();
		var updateUI;
		console.log("BROADCAST CASE : buffer B4 update : " + getBufferContent() );
		updateBuffer( charInMessage , positionInMessage , serverBufferNumberInMessage);
		console.log("Updated buffer. New buffer : " + getBufferContent()  );
	 	if(client_q.length > 5) {
			console.log("Coming inside the if block !");

		   for(i=0;i<queue.length;i++) {
				var qtuple = queue[i].split(",");
				var charInQueue = qtuple[0] ;
				var clientIdInQueue = qtuple[2];
				var positionInQueue = parseInt(qtuple[1]);
				var serverBufferNumberInQueue = qtuple[3];

			 	if( charInQueue != BACKSPACE && charInQueue != DELETE) {

			  		if(qtuple[1] >= positionInMessage){
						if(buff.length > qtuple[1]){
				 			var updateUI = buff.substring(0,positionInQueue+1) + charInQueue + oldBuffer.substring(positionInQueue+1);
							console.log("Coming to the insert in between case  111! ");
							alert("case 1 ");
						} else{
				 			var updateUI = buff + charInQueue;  
							console.log("Coming to the insert  at end case 222 ! ");
							alert("case 2 ");
						}
			  		}
			  		else{
				 		var updateUI = buff.substring(0,positionInQueue) + charInQueue + oldBuffer.substring(positionInQueue);
						console.log("Coming to the insert in between case ! ");
						alert("case 3 ");
					}
			 	}
			 	else if(key == BACKSPACE) {
			   //no operation yet
			 	} else {
			   //no operation yet
			 	}
		   }
		 	setUIContent( updateUI );
	 	} else {

	 	 	console.log("Client Queue is null"); 
			var bufferContent = getBufferContent();
			setUIContent( bufferContent );
	 	}  
	}
}

function setUpPersistantConnection(e)
{
	xmlhttp=new XMLHttpRequest(); 
	xmlhttp.onreadystatechange=function()
	{
		try{
			if( xmlhttp.status==200)
			{
				var responseText = new String(xmlhttp.responseText);
				if(header_sent!=0)
				{
				   //console.log("Response text : " + responseText);
				   updateClientBuf(responseText);
				}
				else
				{
				   //console.log("CHAR got : "+responseText + " , response len ; " + responseText );
				   if(responseText.length!=0)
					{
						header_sent =1; 
						var threadDetails = responseText.split("-");
						setClientId(threadDetails[1]);
					}
				}
			}
		}catch(e)
		{
			//console.log(e.message + " Xml status : ");
		}
	};
	xmlhttp.open("POST","http://192.168.0.9:5000",true);
	xmlhttp.send("STUFF POSTED");
	mainDoc.onkeydown = function(e){keyPress(e);}
};

function returnKeyFromCode(code){
 	if(code == 8)
	 	var charPressed = BACKSPACE;
	 else if(code == 32)
	 	var charPressed = " "; //Spacebar
	 else if(code == 37)
	 	var charPressed = ommit_char;
	 else if(code == 38)
	 	var charPressed = ommit_char;
	 else if(code == 39)
	 	var charPressed = ommit_char;
	 else if(code == 40)
	 	var charPressed = ommit_char;
	 else if(code ==16 || code ==17 || code == 18 || code==9)
	 	var charPressed = ommit_char;
	 else if(code == 46)
	 	var charPressed = DELETE;
	 else
	 	var charPressed = String.fromCharCode(code);

	return charPressed.toLowerCase();

};

function keyPress(e)
{
	var textReplace = document.getElementById("textReplace");
	//alert("key code : "+ e.which + " ,charcode : "+ e.charCode + " , e.keycode : " + e.keyCode );
	var keyPressed = returnKeyFromCode(e.which)  ;
	var buffer_version_number = getBufferVersionNumber();
	var Q_version_number = getQueueVersionNumber();
	//var locationReplace = document.getElementById("location");
	var clientId = getClientId();
	if(keyPressed == ommit_char)
		return;
	//Increment the Q_version number and add it back to the same div
	textReplace.innerHTML = keyPressed;
	//locationReplace.innerHTML = mainDoc.selectionStart;
	Q_version_number = insertQ(keyPressed,mainDoc.selectionStart,clientId);
	//console.log("Q version number : " + Q_version_number);
	xmlhttp1=new XMLHttpRequest();
	xmlhttp1.onreadystatechange=function(){};
	xmlhttp1.open("POST","http://192.168.0.9:5000?key=" + keyPressed + "&pos=" +mainDoc.selectionStart +"&server_revno="+buffer_version_number + "&client_revno=" + Q_version_number +  "&cid="+clientId +"&param=EOS",true);
	xmlhttp1.send("Stuff");
};

function setEventHandlers()
{

	var connectButton=document.getElementById("connectToServer");
	connectButton.onclick=function(e){setUpPersistantConnection(e);}
};

function main()
{
	setEventHandlers();	
}
main();
 </script>
</div>

</body>
</html>
